define(["react","lodash","@grafana/data","@grafana/ui"],(function(e,t,n,r){return function(e){var t={};function n(r){if(t[r])return t[r].exports;var a=t[r]={i:r,l:!1,exports:{}};return e[r].call(a.exports,a,a.exports,n),a.l=!0,a.exports}return n.m=e,n.c=t,n.d=function(e,t,r){n.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:r})},n.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},n.t=function(e,t){if(1&t&&(e=n(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var r=Object.create(null);if(n.r(r),Object.defineProperty(r,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var a in e)n.d(r,a,function(t){return e[t]}.bind(null,a));return r},n.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return n.d(t,"a",t),t},n.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},n.p="/",n(n.s=4)}([function(t,n){t.exports=e},function(e,n){e.exports=t},function(e,t){e.exports=n},function(e,t){e.exports=r},function(e,t,n){"use strict";n.r(t);var r=n(3),a=n(2),o=function(e,t){return(o=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])})(e,t)};function i(e,t){function n(){this.constructor=e}o(e,t),e.prototype=null===t?Object.create(t):(n.prototype=t.prototype,new n)}var s=function(){return(s=Object.assign||function(e){for(var t,n=1,r=arguments.length;n<r;n++)for(var a in t=arguments[n])Object.prototype.hasOwnProperty.call(t,a)&&(e[a]=t[a]);return e}).apply(this,arguments)};function u(e,t,n,r){return new(n||(n=Promise))((function(a,o){function i(e){try{u(r.next(e))}catch(e){o(e)}}function s(e){try{u(r.throw(e))}catch(e){o(e)}}function u(e){var t;e.done?a(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(i,s)}u((r=r.apply(e,t||[])).next())}))}function l(e,t){var n,r,a,o,i={label:0,sent:function(){if(1&a[0])throw a[1];return a[1]},trys:[],ops:[]};return o={next:s(0),throw:s(1),return:s(2)},"function"==typeof Symbol&&(o[Symbol.iterator]=function(){return this}),o;function s(o){return function(s){return function(o){if(n)throw new TypeError("Generator is already executing.");for(;i;)try{if(n=1,r&&(a=2&o[0]?r.return:o[0]?r.throw||((a=r.return)&&a.call(r),0):r.next)&&!(a=a.call(r,o[1])).done)return a;switch(r=0,a&&(o=[2&o[0],a.value]),o[0]){case 0:case 1:a=o;break;case 4:return i.label++,{value:o[1],done:!1};case 5:i.label++,r=o[1],o=[0];continue;case 7:o=i.ops.pop(),i.trys.pop();continue;default:if(!(a=i.trys,(a=a.length>0&&a[a.length-1])||6!==o[0]&&2!==o[0])){i=0;continue}if(3===o[0]&&(!a||o[1]>a[0]&&o[1]<a[3])){i.label=o[1];break}if(6===o[0]&&i.label<a[1]){i.label=a[1],a=o;break}if(a&&i.label<a[2]){i.label=a[2],i.ops.push(o);break}a[2]&&i.ops.pop(),i.trys.pop();continue}o=t.call(e,i)}catch(e){o=[6,e],r=0}finally{n=a=0}if(5&o[0])throw o[1];return{value:o[0]?o[1]:void 0,done:!0}}([o,s])}}}function c(e,t){var n="function"==typeof Symbol&&e[Symbol.iterator];if(!n)return e;var r,a,o=n.call(e),i=[];try{for(;(void 0===t||t-- >0)&&!(r=o.next()).done;)i.push(r.value)}catch(e){a={error:e}}finally{try{r&&!r.done&&(n=o.return)&&n.call(o)}finally{if(a)throw a.error}}return i}function p(){for(var e=[],t=0;t<arguments.length;t++)e=e.concat(c(arguments[t]));return e}var f=n(1),m=function(){this.table="",this.fields="",this.query="",this.titleField="",this.descriptionField="",this.startTimeField="",this.endTimeField="",this.limit=25};function h(e){return(h="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}var d=function(){function e(e){var t=this;this.resultFormat="table",this.query=new m,this.output={columns:[],rows:[],type:"table"},e.filter((function(e){return e&&e.result&&e.result.data&&e.result.data.result})).forEach((function(e){t.query=e.query,e&&e.query&&e.query.servicenow&&"stats"===e.query.servicenow.type?(t.resultFormat=e.query.servicenow.result_format,e.result.data.result.forEach((function(e,n){0===n&&(t.output.columns.push({text:"stat",type:"string"}),t.output.columns.push({text:"value",type:"number"})),t.output.rows.push([e.groupby_fields[0].display_value||e.groupby_fields[0].value,e.stats.count])}))):e.result.data.result.forEach((function(e,n){0===n&&Object(f.forEach)(e,(function(e,n){"object"===h(e)&&e&&(e.display_value||""===e.value)?t.output.columns.push({text:n,type:"string"}):t.output.columns.push({text:n,type:"object"===h(e)?"string":h(e)})}));var r=[];Object(f.forEach)(e,(function(e){"object"===h(e)&&e&&(e.display_value||""===e.value)?r.push(e.display_value||e.value):"object"===h(e)?r.push(JSON.stringify(e)):r.push(e)})),t.output.rows.push(r)}))}))}return e.prototype.getResultsAsAnnotations=function(){var e=this,t=[];return Object(f.forEach)(this.output.rows,(function(n){var r=function(e,t,n){var r={text:"",title:"",tags:[],time:(new Date).getTime()},a="";return Object(f.forEach)(t,(function(t,o){t.text===n.startTimeField?e[o]&&(r.time=new Date(e[o]).getTime(),a+=t.text+" : "+e[o]+"\n"):t.text===n.endTimeField?e[o]&&(r.timeEnd=new Date(e[o]).getTime(),a+=t.text+" : "+e[o]+"\n"):t.text===n.titleField?e[o]&&(r.title=e[o]):t.text===n.descriptionField?e[o]&&(r.text=e[o]):e[o]&&r.tags.push(t.text+" : "+e[o])})),r.text+="\n    "+a+"\n  ",r}(n,e.output.columns,e.query);t.push(r)})),t},e.prototype.getResultsAsTimeSeries=function(e){var t=[];return this.output.rows.forEach((function(n){t.push({target:n[0]||"-",datapoints:[[n[1],e]]})})),t},e}(),v=function(){function e(e,t){this.instanceSettings=e,this.backendSrv=t,this.url="",this.url=this.instanceSettings.url+""}return e.prototype.doServiceNowRequest=function(e,t){var n=this;void 0===t&&(t=1);var r=[];if(r.push("sysparm_limit="+(e.limit||10)),r.push("sysparm_display_value=all"),e.fields&&"*"!==e.fields&&r.push("sysparm_fields="+(e.fields||"opened_at,number,short_description,sys_created_by,severity,category,state,priority")),e.query){var a=[e.query.trim().replace(/\^\n/g,"^").replace(/\n/g,"^")].filter(Boolean);r.push("sysparm_query="+a.join("^"))}return"stats"===e.type&&(r.push("sysparm_count=true"),e.groupBy&&r.push("sysparm_group_by="+e.groupBy.trim())),this.backendSrv.datasourceRequest({method:"GET",url:this.url+"/api/now/"+(e.type||"table")+"/"+e.table+"?"+r.join("&")}).catch((function(r){if(console.log(r),t>0)return n.doServiceNowRequest(e,t-1);throw r}))},e.prototype.doQueries=function(e,t){var n=this;return e.map((function(e){return n.doServiceNowRequest(e.servicenow).then((function(n){return{result:n,query:e,options:t}})).catch((function(t){throw{error:t,query:e}}))}))},e.prototype.query=function(e){var t=[];e.targets&&(t=e.targets.filter((function(e){return!0!==e.hide})));var n=this.doQueries(t,e);return Promise.all(n).then((function(e){var t=new d(e);return"time_series"===t.resultFormat?t.getResultsAsTimeSeries(new Date(e[0].options.range.to).getTime()):t.output}))},e.prototype.doAnnotationQueries=function(e){var t=this;return e.map((function(e){return t.doServiceNowRequest(e).then((function(t){return{result:t,query:e}})).catch((function(t){throw{error:t,query:e}}))}))},e.prototype.annotationsQuery=function(e){var t=[];e.targets?t=e.targets.filter((function(e){return!0!==e.hide})):e.annotation&&t.push({limit:e.annotation.limit||30,startTimeField:e.annotation.startTimeField,endTimeField:e.annotation.endTimeField,titleField:e.annotation.titleField,descriptionField:e.annotation.descriptionField,fields:p(e.annotation.fields.split(","),[e.annotation.titleField,e.annotation.descriptionField,e.annotation.startTimeField,e.annotation.endTimeField]).filter(Boolean).join(","),query:e.annotation.query||"",table:e.annotation.table});var n=this.doAnnotationQueries(t);return Promise.all(n).then((function(e){return new d(e).getResultsAsAnnotations()}))},e}(),y=function(e){function t(t,n,r){var a=e.call(this,t)||this;return a.instanceSettings=t,a.backendSrv=n,a.templateSrv=r,a.serviceNowDataSource=new v(a.instanceSettings,a.backendSrv),a}return t.$inject=["instanceSettings","backendSrv","templateSrv"],i(t,e),t.prototype.query=function(e){var t=[],n=Object(f.cloneDeep)(e);if(n.targets.length>0){var r=this.serviceNowDataSource.query(n);r&&t.push(r)}return Promise.all(t).then((function(e){return{data:Object(f.flatten)(e)}}))},t.prototype.annotationQuery=function(e){e.annotation.query=this.templateSrv.replace(e.annotation.query,{},"glob");var t={range:e.range,rangeRaw:e.rangeRaw,annotation:e.annotation};return this.serviceNowDataSource.annotationsQuery(t).then((function(e){return e})).catch((function(e){return console.error(e),[]}))},t.prototype.testDatasource=function(){var e=this;return new Promise((function(t,n){return u(e,void 0,void 0,(function(){return l(this,(function(e){return this.serviceNowDataSource.query({range:{from:"",to:""},targets:[]}).then((function(e){t({message:"Successfully Connected ServiceNow",status:"success"})})).catch((function(e){n({message:"Failed to Connect ServiceNow",status:"error"})})),[2]}))}))}))},t.prototype.metricFindQuery=function(e){return Promise.resolve([])},t}(a.DataSourceApi),g=n(0),b=n.n(g),w=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t.onURLChange=function(e){var n=t.props,r=n.onOptionsChange,a=n.options;r(s(s({},a),{url:e.target.value}))},t.onUserNameChange=function(e){var n=t.props,r=n.onOptionsChange,a=n.options;r(s(s({},a),{basicAuthUser:e.target.value}))},t.onPasswordChange=function(e){var n=t.props,r=n.onOptionsChange,a=n.options;r(s(s({},a),{secureJsonData:{basicAuthPassword:e.target.value}}))},t.onResetPassword=function(){var e=t.props,n=e.onOptionsChange,r=e.options;n(s(s({},r),{secureJsonFields:s(s({},r.secureJsonFields),{basicAuthPassword:!1}),secureJsonData:s(s({},r.secureJsonData),{basicAuthPassword:""})}))},t}return i(t,e),t.prototype.render=function(){var e=this.props.options;e.basicAuth=!0;var t=e.secureJsonFields,n=e.secureJsonData||{};return b.a.createElement(b.a.Fragment,null,b.a.createElement("h3",{className:"page-heading"},"Service Now Settings"),b.a.createElement("div",{className:"gf-form-inline"},b.a.createElement("div",{className:"gf-form"},b.a.createElement("label",{className:"gf-form-label width-11",title:"Service Now URL"},"Service Now URL"),b.a.createElement("input",{className:"gf-form-input width-20",type:"text",onChange:this.onURLChange,value:e.url||"",placeholder:"https://YOUR_INSTANCE_NAME.service-now.com"}))),b.a.createElement("div",{className:"gf-form-inline"},b.a.createElement("div",{className:"gf-form"},b.a.createElement("label",{className:"gf-form-label width-11",title:"User Name"},"User name"),b.a.createElement("input",{className:"gf-form-input width-20",type:"text",onChange:this.onUserNameChange,value:e.basicAuthUser||"",placeholder:"username"}))),b.a.createElement("div",{className:"gf-form-inline"},b.a.createElement("div",{className:"gf-form"},b.a.createElement("label",{className:"gf-form-label width-11",title:"Password"},"Password"),t&&t.basicAuthPassword?b.a.createElement(b.a.Fragment,null,b.a.createElement("label",{className:"gf-form-label width-20"},"Configured"),b.a.createElement("span",{className:"gf-form-button btn btn-secondary width-6",onClick:this.onResetPassword},"Reset")):b.a.createElement("input",{type:"password",value:n.basicAuthPassword||"",className:"gf-form-input width-20",onChange:this.onPasswordChange}))))},t}(g.PureComponent),E="annotations/annotations.editor.html",C=[{label:"Incidents (INC)",value:"incident"},{label:"Change Request (CHG)",value:"change_request"}],N=C,S=[{label:"Table",value:"table"},{label:"Stats",value:"stats"}],q=[{label:"Table",value:"table"},{label:"Time Series",value:"time_series"}],F=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t.onTableChange=function(e){var n=t.props,r=n.query,a=n.onChange,o=r.servicenow;o.table=e.value,a(s(s({},r),{servicenow:o}))},t.onTypeChange=function(e){var n=t.props,r=n.query,a=n.onChange,o=r.servicenow;o.type=e.value,a(s(s({},r),{servicenow:o}))},t}return i(t,e),t.prototype.render=function(){var e=this.props.query;return b.a.createElement("div",null,b.a.createElement("div",{className:"gf-form-inline"},b.a.createElement("div",{className:"gf-form"},b.a.createElement("label",{className:"gf-form-label query-keyword width-8"},"Table"),b.a.createElement("div",{className:"gf-form-select-wrapper gf-form-select-wrapper--caret-indent"},b.a.createElement(r.Select,{className:"width-12",value:N.find((function(t){return t.value===e.servicenow.table})),options:N,defaultValue:e.servicenow.table,onChange:this.onTableChange}))),b.a.createElement("div",{className:"gf-form"},b.a.createElement("label",{className:"gf-form-label query-keyword width-6"},"Type"),b.a.createElement("div",{className:"gf-form-select-wrapper gf-form-select-wrapper--caret-indent"},b.a.createElement(r.Select,{className:"width-12",value:S.find((function(t){return t.value===e.servicenow.type})),options:S,defaultValue:e.servicenow.type,onChange:this.onTypeChange})))))},t}(g.PureComponent),_=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t.onFieldChange=function(e){var n=e.target.value,r=t.props,a=r.query,o=r.onChange,i=a.servicenow;i.fields=n,o(s(s({},a),{servicenow:i}))},t}return i(t,e),t.prototype.render=function(){var e=this.props.query;return b.a.createElement("div",null,b.a.createElement("div",{className:"gf-form-inline"},b.a.createElement("div",{className:"gf-form"},b.a.createElement("label",{className:"gf-form-label width-8",title:"Fields ( Comma separated )"},"Fields"),b.a.createElement("input",{className:"gf-form-input width-30",type:"text",onChange:this.onFieldChange,value:e.servicenow.fields,placeholder:"Fields ( Comma Separated)",title:"Fields ( Comma Separated )"}))))},t}(g.PureComponent),x=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t.onQueryChange=function(e){var n=e.target.value,r=t.props,a=r.query,o=r.onChange,i=a.servicenow;i.query=n,o(s(s({},a),{servicenow:i}))},t}return i(t,e),t.prototype.render=function(){var e=this.props.query;return b.a.createElement("div",null,b.a.createElement("div",{className:"gf-form-inline"},b.a.createElement("div",{className:"gf-form"},b.a.createElement("label",{className:"gf-form-label width-8",title:"Filter/Query"},"Filter / Query"),b.a.createElement("textarea",{value:e.servicenow.query||"",onChange:this.onQueryChange,className:"gf-form-input min-width-30 width-30",rows:3}))))},t}(g.PureComponent),P=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t.onGroupByChange=function(e){var n=e.target.value,r=t.props,a=r.query,o=r.onChange,i=a.servicenow;i.groupBy=n,o(s(s({},a),{servicenow:i}))},t}return i(t,e),t.prototype.render=function(){var e=this.props.query;return b.a.createElement("div",null,b.a.createElement("div",{className:"gf-form-inline"},b.a.createElement("div",{className:"gf-form"},b.a.createElement("label",{className:"gf-form-label width-8",title:"Group By Field"},"Group By"),b.a.createElement("input",{className:"gf-form-input width-30",type:"text",onChange:this.onGroupByChange,value:e.servicenow.groupBy,placeholder:"",title:"Group By"}))))},t}(g.PureComponent),T=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t.onLimitChange=function(e){var n=e.target.value,r=t.props,a=r.query,o=r.onChange,i=a.servicenow;i.limit=n,o(s(s({},a),{servicenow:i}))},t.onResultFormatChange=function(e){var n=e.value,r=t.props,a=r.query,o=r.onChange,i=a.servicenow;i.resultFormat=n,o(s(s({},a),{servicenow:i}))},t}return i(t,e),t.prototype.render=function(){var e=this.props.query;return b.a.createElement("div",null,b.a.createElement("div",{className:"gf-form-inline"},b.a.createElement("div",{className:"gf-form"},b.a.createElement("label",{className:"gf-form-label width-8",title:"Limit"},"Limit"),b.a.createElement("input",{className:"gf-form-input width-10",type:"text",onChange:this.onLimitChange,value:e.servicenow.limit,placeholder:"Limit",title:"Limit"}),b.a.createElement("label",{className:"gf-form-label width-8",title:"Format As"},"Format As"),b.a.createElement("div",{className:"gf-form-select-wrapper gf-form-select-wrapper--caret-indent"},b.a.createElement(r.Select,{className:"width-12",value:q.find((function(t){return t.value===e.servicenow.resultFormat})),options:q,defaultValue:e.servicenow.resultFormat,onChange:this.onResultFormatChange})))))},t}(g.PureComponent),O={table:"incident",type:"table",fields:"opened_at,number,short_description,sys_created_by,severity,category,state,priority",query:"ORDERBYDESCopened_at",group_by:"",result_format:"time_series",limit:10},j=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return i(t,e),t.prototype.render=function(){var e,t=Object(f.defaults)(this.props.query,{servicenow:Object(f.defaults)(this.props.query.servicenow,O)});return t&&t.servicenow&&"stats"===t.servicenow.type&&(e=b.a.createElement(P,{onChange:this.props.onChange,query:t,datasource:this.props.datasource})),b.a.createElement("div",null,b.a.createElement(F,{onChange:this.props.onChange,query:t,datasource:this.props.datasource}),b.a.createElement(_,{onChange:this.props.onChange,query:t,datasource:this.props.datasource}),b.a.createElement(x,{onChange:this.props.onChange,query:t,datasource:this.props.datasource}),e,b.a.createElement(T,{onChange:this.props.onChange,query:t,datasource:this.props.datasource}))},t}(g.PureComponent),R=function(){function e(){this.supportedTables=C.map((function(e){return{text:e.label,value:e.value}}))}return e.templateUrl=E,e}();n.d(t,"plugin",(function(){return A}));var A=new a.DataSourcePlugin(y).setConfigEditor(w).setQueryEditor(j).setAnnotationQueryCtrl(R)}])}));