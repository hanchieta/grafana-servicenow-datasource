define(["react","lodash","@grafana/data","@grafana/ui"],(function(e,t,n,r){return function(e){var t={};function n(r){if(t[r])return t[r].exports;var o=t[r]={i:r,l:!1,exports:{}};return e[r].call(o.exports,o,o.exports,n),o.l=!0,o.exports}return n.m=e,n.c=t,n.d=function(e,t,r){n.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:r})},n.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},n.t=function(e,t){if(1&t&&(e=n(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var r=Object.create(null);if(n.r(r),Object.defineProperty(r,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var o in e)n.d(r,o,function(t){return e[t]}.bind(null,o));return r},n.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return n.d(t,"a",t),t},n.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},n.p="/",n(n.s=4)}([function(t,n){t.exports=e},function(e,n){e.exports=t},function(e,t){e.exports=n},function(e,t){e.exports=r},function(e,t,n){"use strict";n.r(t);var r=n(3),o=n(2),a=function(e,t){return(a=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])})(e,t)};function i(e,t){function n(){this.constructor=e}a(e,t),e.prototype=null===t?Object.create(t):(n.prototype=t.prototype,new n)}var u=function(){return(u=Object.assign||function(e){for(var t,n=1,r=arguments.length;n<r;n++)for(var o in t=arguments[n])Object.prototype.hasOwnProperty.call(t,o)&&(e[o]=t[o]);return e}).apply(this,arguments)};function l(e,t,n,r){return new(n||(n=Promise))((function(o,a){function i(e){try{l(r.next(e))}catch(e){a(e)}}function u(e){try{l(r.throw(e))}catch(e){a(e)}}function l(e){var t;e.done?o(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(i,u)}l((r=r.apply(e,t||[])).next())}))}function s(e,t){var n,r,o,a,i={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return a={next:u(0),throw:u(1),return:u(2)},"function"==typeof Symbol&&(a[Symbol.iterator]=function(){return this}),a;function u(a){return function(u){return function(a){if(n)throw new TypeError("Generator is already executing.");for(;i;)try{if(n=1,r&&(o=2&a[0]?r.return:a[0]?r.throw||((o=r.return)&&o.call(r),0):r.next)&&!(o=o.call(r,a[1])).done)return o;switch(r=0,o&&(a=[2&a[0],o.value]),a[0]){case 0:case 1:o=a;break;case 4:return i.label++,{value:a[1],done:!1};case 5:i.label++,r=a[1],a=[0];continue;case 7:a=i.ops.pop(),i.trys.pop();continue;default:if(!(o=i.trys,(o=o.length>0&&o[o.length-1])||6!==a[0]&&2!==a[0])){i=0;continue}if(3===a[0]&&(!o||a[1]>o[0]&&a[1]<o[3])){i.label=a[1];break}if(6===a[0]&&i.label<o[1]){i.label=o[1],o=a;break}if(o&&i.label<o[2]){i.label=o[2],i.ops.push(a);break}o[2]&&i.ops.pop(),i.trys.pop();continue}a=t.call(e,i)}catch(e){a=[6,e],r=0}finally{n=o=0}if(5&a[0])throw a[1];return{value:a[0]?a[1]:void 0,done:!0}}([a,u])}}}function c(e,t){var n="function"==typeof Symbol&&e[Symbol.iterator];if(!n)return e;var r,o,a=n.call(e),i=[];try{for(;(void 0===t||t-- >0)&&!(r=a.next()).done;)i.push(r.value)}catch(e){o={error:e}}finally{try{r&&!r.done&&(n=a.return)&&n.call(a)}finally{if(o)throw o.error}}return i}function f(){for(var e=[],t=0;t<arguments.length;t++)e=e.concat(c(arguments[t]));return e}var p=n(1);function d(e){return(d="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}var m=function(){function e(e){var t=this;this.query="",this.output={columns:[],rows:[],type:"table"},e.filter((function(e){return e&&e.result&&e.result.data&&e.result.data.result})).forEach((function(e){t.query=e.query,e.result.data.result.forEach((function(e,n){0===n&&Object(p.forEach)(e,(function(e,n){"object"===d(e)&&e&&(e.display_value||""===e.value)?t.output.columns.push({text:n,type:"string"}):t.output.columns.push({text:n,type:"object"===d(e)?"string":d(e)})}));var r=[];Object(p.forEach)(e,(function(e){"object"===d(e)&&e&&(e.display_value||""===e.value)?r.push(e.display_value||e.value):"object"===d(e)?r.push(JSON.stringify(e)):r.push(e)})),t.output.rows.push(r)}))}))}return e.prototype.getResultsAsAnnotations=function(){var e=this,t=[];return Object(p.forEach)(this.output.rows,(function(n){var r=function(e,t,n){var r={text:"",title:"",tags:[],time:(new Date).getTime()},o="";return Object(p.forEach)(t,(function(t,a){t.text===n.startTimeField?e[a]&&(r.time=new Date(e[a]).getTime(),o+=t.text+" : "+e[a]+"\n"):t.text===n.endTimeField?e[a]&&(r.timeEnd=new Date(e[a]).getTime(),o+=t.text+" : "+e[a]+"\n"):t.text===n.titleField?e[a]&&(r.title=e[a]):t.text===n.descriptionField?e[a]&&(r.text=e[a]):e[a]&&r.tags.push(t.text+" : "+e[a])})),r.text+="\n    "+o+"\n  ",r}(n,e.output.columns,e.query);t.push(r)})),t},e}(),y=function(){function e(e,t){this.instanceSettings=e,this.backendSrv=t,this.url="",this.url=this.instanceSettings.url+"/servicenow"}return e.prototype.doServiceNowRequest=function(e,t){var n=this;void 0===t&&(t=1);var r=[];if(r.push("sysparm_limit="+(e.limit||10)),r.push("sysparm_display_value=all"),e.fields&&"*"!==e.fields&&r.push("sysparm_fields="+(e.fields||"opened_at,number,short_description,sys_created_by,severity,category,state,priority")),e.query){var o=[e.query];r.push("sysparm_query="+o.join("^"))}return this.backendSrv.datasourceRequest({method:"GET",url:this.url+"/api/now/"+(e.type||"table")+"/"+e.table+"?"+r.join("&")}).catch((function(r){if(console.log(r),t>0)return n.doServiceNowRequest(e,t-1);throw r}))},e.prototype.doQueries=function(e){var t=this;return e.map((function(e){return t.doServiceNowRequest(e.servicenow).then((function(t){return{result:t,query:e}})).catch((function(t){throw{error:t,query:e}}))}))},e.prototype.query=function(e){var t=[];e.targets&&(t=e.targets.filter((function(e){return!0!==e.hide})));var n=this.doQueries(t);return Promise.all(n).then((function(e){return new m(e).output}))},e.prototype.doAnnotationQueries=function(e){var t=this;return e.map((function(e){return t.doServiceNowRequest(e).then((function(t){return{result:t,query:e}})).catch((function(t){throw{error:t,query:e}}))}))},e.prototype.annotationsQuery=function(e){var t=[];e.targets?t=e.targets.filter((function(e){return!0!==e.hide})):e.annotation&&t.push({limit:e.annotation.limit||30,startTimeField:e.annotation.startTimeField,endTimeField:e.annotation.endTimeField,titleField:e.annotation.titleField,descriptionField:e.annotation.descriptionField,fields:f(e.annotation.fields.split(","),[e.annotation.titleField,e.annotation.descriptionField,e.annotation.startTimeField,e.annotation.endTimeField]).filter(Boolean).join(","),query:e.annotation.query||"",table:e.annotation.table});var n=this.doAnnotationQueries(t);return Promise.all(n).then((function(e){return new m(e).getResultsAsAnnotations()}))},e}(),h=function(e){function t(t,n,r){var o=e.call(this,t)||this;return o.instanceSettings=t,o.backendSrv=n,o.templateSrv=r,o.serviceNowDataSource=new y(o.instanceSettings,o.backendSrv),o}return t.$inject=["instanceSettings","backendSrv","templateSrv"],i(t,e),t.prototype.query=function(e){var t=[],n=Object(p.cloneDeep)(e);if(n.targets.length>0){var r=this.serviceNowDataSource.query(n);r&&t.push(r)}return Promise.all(t).then((function(e){return{data:Object(p.flatten)(e)}}))},t.prototype.annotationQuery=function(e){e.annotation.query=this.templateSrv.replace(e.annotation.query,{},"glob");var t={range:e.range,rangeRaw:e.rangeRaw,annotation:e.annotation};return this.serviceNowDataSource.annotationsQuery(t).then((function(e){return e})).catch((function(e){return console.error(e),[]}))},t.prototype.testDatasource=function(){var e=this;return new Promise((function(t,n){return l(e,void 0,void 0,(function(){return s(this,(function(e){return this.serviceNowDataSource.query({range:{from:"",to:""},targets:[]}).then((function(e){t({message:"Successfully Connected ServiceNow",status:"success"})})).catch((function(e){n({message:"Failed to Connect ServiceNow",status:"error"})})),[2]}))}))}))},t.prototype.metricFindQuery=function(e){return Promise.resolve([])},t}(o.DataSourceApi),v=n(0),g=n.n(v),b="config/config.html",w="annotations/annotations.editor.html",S=[{label:"Incidents (INC)",value:"incident"},{label:"Change Request (CHG)",value:"change_request"}],q=S,E=[{label:"Table",value:"table"}],C={table:"incident",type:"table",fields:"opened_at,number,short_description,sys_created_by,severity,category,state,priority",query:"ORDERBYDESCopened_at",limit:10},N=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t.state={},t.onTableChange=function(e){var n=t.props,r=n.query,o=n.onChange,a=r.servicenow;a.table=e.value,o(u(u({},r),{servicenow:a}))},t.onTypeChange=function(e){var n=t.props,r=n.query,o=n.onChange,a=r.servicenow;a.type=e.value,o(u(u({},r),{servicenow:a}))},t.onFieldChange=function(e){var n=e.target.value,r=t.props,o=r.query,a=r.onChange,i=o.servicenow;i.fields=n,a(u(u({},o),{servicenow:i}))},t.onQueryChange=function(e){var n=e.target.value,r=t.props,o=r.query,a=r.onChange,i=o.servicenow;i.query=n,a(u(u({},o),{servicenow:i}))},t.onLimitChange=function(e){var n=e.target.value,r=t.props,o=r.query,a=r.onChange,i=o.servicenow;i.fields=n,a(u(u({},o),{servicenow:i}))},t}return i(t,e),t.prototype.render=function(){var e=Object(p.defaults)(this.props.query,{servicenow:Object(p.defaults)(this.props.query.servicenow,C)});return g.a.createElement("div",null,g.a.createElement("div",{className:"gf-form-inline"},g.a.createElement("div",{className:"gf-form"},g.a.createElement("label",{className:"gf-form-label query-keyword width-8"},"Table"),g.a.createElement("div",{className:"gf-form-select-wrapper gf-form-select-wrapper--caret-indent"},g.a.createElement(r.Select,{className:"width-12",value:q.find((function(t){return t.value===e.servicenow.table})),options:q,defaultValue:e.servicenow.table,onChange:this.onTableChange}))),g.a.createElement("div",{className:"gf-form"},g.a.createElement("label",{className:"gf-form-label query-keyword width-8"},"Type"),g.a.createElement("div",{className:"gf-form-select-wrapper gf-form-select-wrapper--caret-indent"},g.a.createElement(r.Select,{className:"width-12",value:E.find((function(t){return t.value===e.servicenow.type})),options:E,defaultValue:e.servicenow.type,onChange:this.onTypeChange})))),g.a.createElement("div",{className:"gf-form-inline"},g.a.createElement("div",{className:"gf-form"},g.a.createElement("label",{className:"gf-form-label width-8",title:"Fields ( Comma separated )"},"Fields"),g.a.createElement("input",{className:"gf-form-input width-30",type:"text",onChange:this.onFieldChange,value:e.servicenow.fields,placeholder:"Fields ( Comma Separated)",title:"Fields ( Comma Separated )"}))),g.a.createElement("div",{className:"gf-form-inline"},g.a.createElement("div",{className:"gf-form"},g.a.createElement("label",{className:"gf-form-label width-8",title:"Filter/Query"},"Filter / Query"),g.a.createElement("textarea",{value:e.servicenow.query||"",onChange:this.onQueryChange,className:"gf-form-input min-width-30 width-30",rows:10}))),g.a.createElement("div",{className:"gf-form-inline"},g.a.createElement("div",{className:"gf-form"},g.a.createElement("label",{className:"gf-form-label width-8",title:"Limit"},"Limit"),g.a.createElement("input",{className:"gf-form-input width-30",type:"text",onChange:this.onFieldChange,value:e.servicenow.limit,placeholder:"Limit",title:"Limit"}))))},t}(v.PureComponent),_=function(){function e(){}return e.templateUrl=b,e}(),x=function(){function e(){this.supportedTables=S}return e.templateUrl=w,e}();n.d(t,"plugin",(function(){return j}));var j=new o.DataSourcePlugin(h).setConfigCtrl(_).setQueryEditor(N).setAnnotationQueryCtrl(x)}])}));