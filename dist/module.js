define(["react","lodash","@grafana/data","@grafana/ui","@grafana/runtime"],(function(e,t,a,r,n){return function(e){var t={};function a(r){if(t[r])return t[r].exports;var n=t[r]={i:r,l:!1,exports:{}};return e[r].call(n.exports,n,n.exports,a),n.l=!0,n.exports}return a.m=e,a.c=t,a.d=function(e,t,r){a.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:r})},a.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},a.t=function(e,t){if(1&t&&(e=a(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var r=Object.create(null);if(a.r(r),Object.defineProperty(r,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var n in e)a.d(r,n,function(t){return e[t]}.bind(null,n));return r},a.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return a.d(t,"a",t),t},a.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},a.p="/",a(a.s=5)}([function(t,a){t.exports=e},function(e,a){e.exports=t},function(e,t){e.exports=a},function(e,t){e.exports=r},function(e,t){e.exports=n},function(e,t,a){"use strict";a.r(t);var r=a(3),n=a(2),l=a(4),i=function(e,t){return(i=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var a in t)t.hasOwnProperty(a)&&(e[a]=t[a])})(e,t)};function o(e,t){function a(){this.constructor=e}i(e,t),e.prototype=null===t?Object.create(t):(a.prototype=t.prototype,new a)}var s=function(){return(s=Object.assign||function(e){for(var t,a=1,r=arguments.length;a<r;a++)for(var n in t=arguments[a])Object.prototype.hasOwnProperty.call(t,n)&&(e[n]=t[n]);return e}).apply(this,arguments)};function u(e,t,a,r){return new(a||(a=Promise))((function(n,l){function i(e){try{s(r.next(e))}catch(e){l(e)}}function o(e){try{s(r.throw(e))}catch(e){l(e)}}function s(e){var t;e.done?n(e.value):(t=e.value,t instanceof a?t:new a((function(e){e(t)}))).then(i,o)}s((r=r.apply(e,t||[])).next())}))}function c(e,t){var a,r,n,l,i={label:0,sent:function(){if(1&n[0])throw n[1];return n[1]},trys:[],ops:[]};return l={next:o(0),throw:o(1),return:o(2)},"function"==typeof Symbol&&(l[Symbol.iterator]=function(){return this}),l;function o(l){return function(o){return function(l){if(a)throw new TypeError("Generator is already executing.");for(;i;)try{if(a=1,r&&(n=2&l[0]?r.return:l[0]?r.throw||((n=r.return)&&n.call(r),0):r.next)&&!(n=n.call(r,l[1])).done)return n;switch(r=0,n&&(l=[2&l[0],n.value]),l[0]){case 0:case 1:n=l;break;case 4:return i.label++,{value:l[1],done:!1};case 5:i.label++,r=l[1],l=[0];continue;case 7:l=i.ops.pop(),i.trys.pop();continue;default:if(!(n=i.trys,(n=n.length>0&&n[n.length-1])||6!==l[0]&&2!==l[0])){i=0;continue}if(3===l[0]&&(!n||l[1]>n[0]&&l[1]<n[3])){i.label=l[1];break}if(6===l[0]&&i.label<n[1]){i.label=n[1],n=l;break}if(n&&i.label<n[2]){i.label=n[2],i.ops.push(l);break}n[2]&&i.ops.pop(),i.trys.pop();continue}l=t.call(e,i)}catch(e){l=[6,e],r=0}finally{a=n=0}if(5&l[0])throw l[1];return{value:l[0]?l[1]:void 0,done:!0}}([l,o])}}}function p(e,t){var a="function"==typeof Symbol&&e[Symbol.iterator];if(!a)return e;var r,n,l=a.call(e),i=[];try{for(;(void 0===t||t-- >0)&&!(r=l.next()).done;)i.push(r.value)}catch(e){n={error:e}}finally{try{r&&!r.done&&(a=l.return)&&a.call(l)}finally{if(n)throw n.error}}return i}function f(){for(var e=[],t=0;t<arguments.length;t++)e=e.concat(p(arguments[t]));return e}var m=a(1),d=function(){function e(e,t){this.key=e,this.value=t.toString()}return e.prototype.getValue=function(){return[this.key,this.value].join("=")},e}(),h=function(){function e(e,t,a,r){void 0===r&&(r="^"),this.condition=r,this.field=e,this.operator=t,this.value=a}return e.prototype.toString=function(){return(""+this.field+this.operator+this.value).trim()},e}(),v=function(){function e(e,t,a,r,n,l,i){void 0===l&&(l=""),void 0===i&&(i="desc"),this.tableName="",this.queryParams=[],this.api=e,this.tableName=t;var o=[this.getNormalizedSysParmQuery(a)+"^"].filter((function(e){return"^"!==e}));r.forEach((function(e,t){var a=t===r.length-1?"":e.condition||"^";o.push(encodeURIComponent((""+e.field+e.operator+e.value+a).trim()))})),l&&o.push(("asc"===i?"^ORDERBY":"^ORDERBYDESC")+l.trim()),this.queryParams.push(new d("sysparm_query",o.join("").replace(/\^\^/g,"^"))),this.queryParams.push(new d("sysparm_display_value",n))}return e.prototype.getNormalizedSysParmQuery=function(e){return(e+"").trim().replace(/\^OR\n/g,"^OR").replace(/\^\n/g,"^").replace(/\n/g,"^")},e.prototype.getUrl=function(){switch(this.api){case"doc":return"/api/now/doc/"+this.tableName;case"table":return"/api/now/table/"+this.tableName+"?"+this.queryParams.map((function(e){return e.getValue()})).join("&");case"stats":return"/api/now/stats/"+this.tableName+"?"+this.queryParams.map((function(e){return e.getValue()})).join("&")}},e}(),y=function(e){function t(t,a,r,n,l,i,o){void 0===n&&(n=10);var s=e.call(this,"table",t,r,l,"all",i,o)||this;return a.length>0&&a[0]&&"*"!==a[0]&&s.queryParams.push(new d("sysparm_fields",a.join(","))),s.queryParams.push(new d("sysparm_limit",n.toString())),s}return o(t,e),t}(v),b=function(e){function t(t,a,r,n,l){void 0===n&&(n="true");var i=e.call(this,"stats",t,r,l,"all","","asc")||this;return i.queryParams.push(new d("sysparm_group_by",a.join(","))),i.queryParams.push(new d("sysparm_count",n)),i}return o(t,e),t}(v),g=new(function(){function e(e){this.table="incident",this.type="table",this.orderByDirection="asc",this.table=e.table||"incident",this.type=e.type||"table",this.fields=e.fields||[],this.query=e.query||"",this.filters=e.filters||[],this.orderByDirection=e.orderByDirection||"asc",this.orderBy=e.orderBy||"",this.groupBy=e.groupBy||[],this.limit=e.limit||25}return e.prototype.getUrl=function(){if("table"===this.type){var e=(this.fields&&"*"!==this.fields[0]?this.fields||"opened_at,number,short_description,sys_created_by,severity,category,state,priority".split(","):[]).filter(Boolean).map((function(e){return e.trim()}));return new y(this.table,e,this.query,this.limit,this.filters,this.orderBy,this.orderByDirection).getUrl()}if("stats"===this.type){var t=(this.groupBy?this.groupBy:[]).filter(Boolean).map((function(e){return e.trim()}));return new b(this.table,t,this.query,"true",this.filters).getUrl()}return""},e}())({table:"incident",type:"table",fields:"opened_at,number,short_description,sys_created_by,severity,category,state,priority".split(","),query:"",groupBy:[],orderBy:"opened_at",orderByDirection:"desc",limit:10});function w(e){return(w="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}var E=function(){function e(e){var t=this;this.output={columns:[],rows:[],type:"table"},e.filter((function(e){return e&&e.result&&e.result.data&&e.result.data.result})).forEach((function(e){t.query=e.query,e&&e.query&&e.query.servicenow&&"stats"===e.query.servicenow.type?e.result.data.result.stats?t.parseResultsAsSingleStat(e):t.parseResultsAsMultiStat(e):t.parseResultsAsTable(e)}))}return e.prototype.parseResultsAsSingleStat=function(e){this.output.columns.push({text:"count",type:"number"}),this.output.rows.push([Object(m.toInteger)(e.result.data.result.stats.count)])},e.prototype.parseResultsAsMultiStat=function(e){var t=this;e.result.data.result.forEach((function(a,r){if(0===r&&e&&e.query&&e.query.servicenow&&e.query.servicenow.groupBy&&(e.query.servicenow.groupBy.filter(Boolean).forEach((function(e){t.output.columns.push({text:e,type:"string"})})),t.output.columns.push({text:"count",type:"number"})),a&&a.stats){var n=Object(m.toInteger)(a.stats.count),l=[];e.query.servicenow.groupBy.filter(Boolean).forEach((function(e){var t=a.groupby_fields.find((function(t){return t.field===e}));t&&l.push(t.display_value||t.value||"-")})),l.push(n),t.output.rows.push(l)}}))},e.prototype.parseResultsAsTable=function(e){var t=this;this.output.columns=[];var a=[];a=e&&e.query&&e.query.servicenow&&e.query.servicenow.fields?e.query.servicenow.fields:a,a=e&&e.query&&e.query&&e.query.fields?e.query.fields:a;var r=Object(m.uniq)(a.filter(Boolean).map((function(e){return e.trim()})).filter(Boolean));a&&"*"!==a[0]&&""!==a[0]?e.result.data.result.forEach((function(e,a){0===a&&Object(m.forEach)(r,(function(e){t.output.columns.push({text:e,type:"string"})}));var n=[];t.output.columns.forEach((function(t){var a=e[t.text];"object"===w(a)&&a&&(a.display_value||""===a.value)?n.push(a.display_value||a.value):"object"===w(a)?n.push(JSON.stringify(a)):n.push(a)})),t.output.rows.push(n)})):e.result.data.result.forEach((function(e,a){0===a&&Object(m.forEach)(e,(function(e,a){"object"===w(e)&&e&&(e.display_value||""===e.value)?t.output.columns.push({text:a,type:"string"}):t.output.columns.push({text:a,type:"object"===w(e)?"string":w(e)})}));var r=[];Object(m.forEach)(e,(function(e){"object"===w(e)&&e&&(e.display_value||""===e.value)?r.push(e.display_value||e.value):"object"===w(e)?r.push(JSON.stringify(e)):r.push(e)})),t.output.rows.push(r)}))},e.prototype.getResultsAsAnnotations=function(){var e=this,t=[];return Object(m.forEach)(this.output.rows,(function(a){var r=function(e,t,a){var r={text:"",title:"",tags:[],time:(new Date).getTime()},n="";return Object(m.forEach)(t,(function(t,l){t.text===a.startTimeField?e[l]&&(r.time=new Date(e[l]).getTime(),n+=t.text+" : "+e[l]+"\n"):t.text===a.endTimeField?e[l]&&(r.timeEnd=new Date(e[l]).getTime(),n+=t.text+" : "+e[l]+"\n"):t.text===a.titleField?e[l]&&(r.title=e[l]):t.text===a.descriptionField?e[l]&&(r.text=e[l]):e[l]&&r.tags.push(t.text+" : "+e[l])})),r.text+="\n    "+n+"\n  ",r}(a,e.output.columns,e.query);t.push(r)})),t},e}(),N=function(e,t,a){var r="javascript:gs.dateGenerate('"+t.format("YYYY-MM-DD")+"','"+t.format("HH:mm:ss")+"')",n="javascript:gs.dateGenerate('"+a.format("YYYY-MM-DD")+"','"+a.format("HH:mm:ss")+"')";return e=(e=(e=e.replace("$__timeFrom()",r)).replace("$__timeTo()",n)).replace("$__timeFilter()",r+"@"+n)},_=function(){function e(e,t){this.instanceSettings=e,this.templateSrv=t,this.url=this.instanceSettings.url}return e.prototype.getServiceNowResults=function(e,t){var a=this;void 0===t&&(t=1);var r=this.url+e.getUrl();return Object(l.getBackendSrv)().datasourceRequest({method:"GET",url:r}).catch((function(r){if(console.log(r),t>0)return a.getServiceNowResults(e,t-1);throw r}))},e.prototype.doQueries=function(e,t){var a=this;return e.map((function(e){var r=e.servicenow;r&&r.query&&(r.query=N(r.query,t.range.from,t.range.to),r.query=a.templateSrv.replace(r.query,{},"glob")),r&&r.filters&&(r.filters=r.filters.map((function(e){return e.value=N(e.value,t.range.from,t.range.to),e.value=a.templateSrv.replace(e.value,{},"glob"),e})));var n=new b("",[],"","true",[]);if(e.servicenow&&"table"===e.servicenow.type){var l=e.servicenow;n=new y(l.table,l.fields.map((function(e){return e.trim()})).filter(Boolean),l.query,l.limit,l.filters,l.orderBy,l.orderByDirection)}else if(e.servicenow&&"stats"===e.servicenow.type){l=e.servicenow;n=new b(l.table,l.groupBy.map((function(e){return e.trim()})).filter(Boolean),l.query,"true",l.filters)}return a.getServiceNowResults(n).then((function(a){return{result:a,query:e,options:t}})).catch((function(t){throw{error:t,query:e}}))}))},e.prototype.doAnnotationQueries=function(e,t){var a=this;return e.map((function(e){e.query=N(e.query,t.range.from,t.range.to);var r=new y(e.table,e.fields,e.query,e.limit,[],e.startTimeField,"asc");return a.getServiceNowResults(r).then((function(t){return{result:t,query:e,options:{}}})).catch((function(t){throw{error:t,query:e}}))}))},e.prototype.query=function(e){var t=[];e.targets&&(t=e.targets.filter((function(e){return!0!==e.hide})));var a=this.doQueries(t,e);return Promise.all(a).then((function(e){return new E(e).output}))},e.prototype.annotationsQuery=function(e){var t=[];if(e.targets)t=e.targets.filter((function(e){return!0!==e.hide}));else if(e.annotation){var a={limit:e.annotation.limit||30,startTimeField:e.annotation.startTimeField,endTimeField:e.annotation.endTimeField,titleField:e.annotation.titleField,descriptionField:e.annotation.descriptionField,fields:f(e.annotation.fields.split(","),[e.annotation.titleField,e.annotation.descriptionField,e.annotation.startTimeField,e.annotation.endTimeField]),query:e.annotation.query||"",table:e.annotation.table};t.push(a)}var r=this.doAnnotationQueries(t,e);return Promise.all(r).then((function(e){return new E(e).getResultsAsAnnotations()}))},e}(),q=function(e){function t(t,a){var r=e.call(this,t)||this;return r.instanceSettings=t,r.templateSrv=a,r.serviceNowInstance=new _(r.instanceSettings,r.templateSrv),r}return t.$inject=["instanceSettings","templateSrv"],o(t,e),t.prototype.query=function(e){var t=[],a=Object(m.cloneDeep)(e);if(a.targets.length>0){var r=this.serviceNowInstance.query(a);r&&t.push(r)}return Promise.all(t).then((function(e){return{data:Object(m.flatten)(e)}}))},t.prototype.annotationQuery=function(e){e.annotation.query=this.templateSrv.replace(e.annotation.query,{},"glob");var t={range:e.range,rangeRaw:e.rangeRaw,annotation:e.annotation};return this.serviceNowInstance.annotationsQuery(t).then((function(e){return e})).catch((function(e){return console.error(e),[]}))},t.prototype.metricFindQuery=function(e){return Promise.resolve([])},t.prototype.testDatasource=function(){var e=this;return new Promise((function(t,a){return u(e,void 0,void 0,(function(){var e;return c(this,(function(r){return e=new v("doc","table/schema","",[],"all","","asc"),this.serviceNowInstance.getServiceNowResults(e,0).then((function(e){e&&200===e.status&&e.data&&e.data.result?t({message:"Successfully Connected ServiceNow."+e.data.result.length+" tables found.",status:"success"}):(console.error(e),a({message:"Failed to Connect ServiceNow",status:"error"}))})).catch((function(e){console.error(e),a({message:"Failed to Connect ServiceNow",status:"error"})})),[2]}))}))}))},t}(n.DataSourceApi),S=a(0),C=a.n(S),T=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t.onURLChange=function(e){var a=t.props,r=a.onOptionsChange,n=a.options;r(s(s({},n),{url:e.target.value}))},t.onUserNameChange=function(e){var a=t.props,r=a.onOptionsChange,n=a.options;r(s(s({},n),{basicAuthUser:e.target.value}))},t.onPasswordChange=function(e){var a=t.props,r=a.onOptionsChange,n=a.options;r(s(s({},n),{secureJsonData:{basicAuthPassword:e.target.value}}))},t.onResetPassword=function(){var e=t.props,a=e.onOptionsChange,r=e.options;a(s(s({},r),{secureJsonFields:s(s({},r.secureJsonFields),{basicAuthPassword:!1}),secureJsonData:s(s({},r.secureJsonData),{basicAuthPassword:""})}))},t}return o(t,e),t.prototype.render=function(){var e=this.props.options;e.basicAuth=!0;var t=e.secureJsonFields,a=e.secureJsonData||{};return C.a.createElement(C.a.Fragment,null,C.a.createElement("h3",{className:"page-heading"},"Service Now Settings"),C.a.createElement("div",{className:"gf-form-inline"},C.a.createElement("div",{className:"gf-form"},C.a.createElement("label",{className:"gf-form-label width-11",title:"Service Now URL"},"Service Now URL"),C.a.createElement("input",{className:"gf-form-input width-20",type:"text",onChange:this.onURLChange,value:e.url||"",placeholder:"https://YOUR_INSTANCE_NAME.service-now.com"}))),C.a.createElement("div",{className:"gf-form-inline"},C.a.createElement("div",{className:"gf-form"},C.a.createElement("label",{className:"gf-form-label width-11",title:"User Name"},"User name"),C.a.createElement("input",{className:"gf-form-input width-20",type:"text",onChange:this.onUserNameChange,value:e.basicAuthUser||"",placeholder:"username"}))),C.a.createElement("div",{className:"gf-form-inline"},C.a.createElement("div",{className:"gf-form"},C.a.createElement("label",{className:"gf-form-label width-11",title:"Password"},"Password"),t&&t.basicAuthPassword?C.a.createElement(C.a.Fragment,null,C.a.createElement("label",{className:"gf-form-label width-20"},"Configured"),C.a.createElement("span",{className:"gf-form-button btn btn-secondary width-6",onClick:this.onResetPassword},"Reset")):C.a.createElement("input",{type:"password",value:a.basicAuthPassword||"",className:"gf-form-input width-20",onChange:this.onPasswordChange}))))},t}(S.PureComponent),F=function(e,t,a,r){void 0===r&&(r="string");var n=a.query,l=a.onChange,i=n.servicenow;Object(m.set)(i,t,"number"===r?Object(m.toInteger)(e.value):e.value),l(s(s({},n),{servicenow:i}))},O=function(e,t,a,r){void 0===r&&(r=!1);var n=a.query,l=a.onChange,i=n.servicenow,o=r?e.target.value.split(","):e.target.value;Object(m.set)(i,t,o),l(s(s({},n),{servicenow:i}))},R=[{label:"Incidents (INC)",value:"incident",short_code:"INC"},{label:"Change Request (CHG)",value:"change_request",short_code:"CHG"},{label:"Problem (PRB)",value:"problem",short_code:"PRB"},{label:"System User Group",value:"sys_user_group",short_code:""}],A=[{label:"Table",value:"table"},{label:"Stats",value:"stats"}],B=[{value:"active",label:"Active",tables:["incident","change_request","problem"]},{value:"assigned_to",label:"Assigned To",tables:["incident","change_request","problem"]},{value:"assignment_group.name",label:"Assignment Group",tables:["incident","change_request","problem"]},{value:"assignment_group",label:"Assignment Group ID",tables:["incident","change_request","problem"]},{value:"description",label:"Description",tables:["incident","change_request","problem","sys_user_group"]},{value:"end_date",label:"End Date",tables:["change_request"],FieldType:n.FieldType.time},{value:"incident_state",label:"Incident State",tables:["incident"]},{value:"number",label:"Number",tables:["incident","change_request","problem"]},{value:"opened_at",label:"Opened At",tables:["incident","change_request","problem"],FieldType:n.FieldType.time},{value:"priority",label:"Priority",tables:["incident","change_request","problem"]},{value:"short_description",label:"Short Description",tables:["incident","change_request","problem"]},{value:"start_date",label:"Start Date",tables:["change_request"],FieldType:n.FieldType.time},{value:"state",label:"State",tables:["incident","change_request","problem"]},{value:"sys_created_by",label:"Created By",tables:["incident","change_request","problem"]},{value:"sys_created_on",label:"Created On",tables:["incident","change_request","problem"],FieldType:n.FieldType.time},{value:"urgency",label:"Urgency",tables:["problem"]},{value:"category",label:"Category",tables:["problem"]},{value:"subcategory",label:"Subcategory",tables:["problem"]},{value:"name",label:"Name",tables:["sys_user_group"]},{value:"manager",label:"Manager",tables:["sys_user_group"]},{value:"email",label:"Email",tables:["sys_user_group"]}],P=B.filter((function(e){return e.FieldType===n.FieldType.time})),x=[{value:"^",label:"AND"},{value:"^OR",label:"OR"}],L=[{value:"=",label:"Equals"},{value:"!=",label:"Not Equals"},{value:"<",label:"Less than"},{value:"<=",label:"Less than or Equals"},{value:">",label:"Greater than"},{value:">=",label:"Greater than or Equals"},{value:"STARTSWITH",label:"Starts With"},{value:"ENDSWITH",label:"Ends With"},{value:"LIKE",label:"Like"},{value:"NOT LIKE",label:"Not Like"},{value:"ISEMPTY",label:"Is Empty"},{value:"ISNOTEMPTY",label:"Is Not Empty"},{value:"IN",label:"In"},{value:"NOT IN",label:"Not In"},{value:"ANYTHING",label:"Anything"},{value:"BETWEEN",label:"Between"},{value:"SAMEAS",label:"Is Same"},{value:"NSAMEAS",label:"Is Different"},{value:"ONToday",label:"On Today"},{value:"NOTONToday",label:"Not On Today"},{value:"DATEPART",label:"Date Part"},{value:"RELATIVEGE",label:"Relative (on or after)"},{value:"RELATIVELE",label:"Relative (on or before)"},{value:"RELATIVEGT",label:"Relative (after)"},{value:"RELATIVELT",label:"Relative (before)"},{value:"RELATIVEEE",label:"Relative (on)"},{value:"MORETHAN",label:"Is More than"},{value:"LESSTHAN",label:"Is Less than"},{value:"GT_FIELD",label:"Greater than field"},{value:"LT_FIELD",label:"Less than field"},{value:"GT_OR_EQUALS_FIELD",label:"Greater than or is field"},{value:"LT_OR_EQUALS_FIELD",label:"Less than or is field"}],j={active:[{label:"True",value:"true"},{label:"False",value:"false"}],grafanaTimestamps:[{label:"Grafana Start Time",value:"$__timeFrom()"},{label:"Grafana End Time",value:"$__timeTo()"},{label:"Grafana Time Range",value:"$__timeFilter()"}]},D=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return o(t,e),t.prototype.render=function(){var e=this,t=this.props.query;return C.a.createElement("div",null,C.a.createElement("div",{className:"gf-form-inline"},C.a.createElement("div",{className:"gf-form"},C.a.createElement("label",{className:"gf-form-label query-keyword width-8"},"Table"),C.a.createElement(r.Select,{className:"width-12",value:R.find((function(e){return e.value===t.servicenow.table}))||{label:t.servicenow.table,value:t.servicenow.table},options:R,defaultValue:t.servicenow.table,onChange:function(t){return F(t,"table",e.props)},allowCustomValue:!0})),C.a.createElement("div",{className:"gf-form"},C.a.createElement("label",{className:"gf-form-label query-keyword width-6"},"Type"),C.a.createElement(r.Select,{className:"width-12",value:A.find((function(e){return e.value===t.servicenow.type})),options:A,defaultValue:t.servicenow.type,onChange:function(t){return F(t,"type",e.props)}}))))},t}(S.PureComponent),I=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t.state={showFieldsListModal:!1,selectedTable:"",fieldsList:[]},t.showFieldsListModal=function(e){return function(){e&&t.retrieveFieldsList(),t.setState({showFieldsListModal:e})}},t}return o(t,e),t.prototype.retrieveFieldsList=function(e){var t=this;if(void 0===e&&(e=!1),this.props.query.servicenow.table!==this.state.selectedTable||e){this.setState({selectedTable:this.props.query.servicenow.table});var a=new _(this.props.datasource.instanceSettings,null),r=new v("doc","table/schema/"+this.props.query.servicenow.table,"",[],"all","","asc");a.getServiceNowResults(r).then((function(e){e&&e.data&&e.data.result&&t.setState({fieldsList:e.data.result})}))}},t.prototype.addField=function(e){var t=this.props,a=t.query,r=t.onChange,n=a.servicenow;n[this.props.fieldName]=n[this.props.fieldName]||[],n[this.props.fieldName].push(e),r(s(s({},a),{servicenow:n}))},t.prototype.removeField=function(e){var t=this.props,a=t.query,r=t.onChange,n=a.servicenow;n[this.props.fieldName]=n[this.props.fieldName]||[],n[this.props.fieldName]=n[this.props.fieldName].filter((function(t){return t!==e})),r(s(s({},a),{servicenow:n}))},t.prototype.componentWillMount=function(){this.setState({selectedTable:this.props.query.servicenow.table}),this.retrieveFieldsList(!0)},t.prototype.render=function(){var e=this,t=this.state.showFieldsListModal;return C.a.createElement(C.a.Fragment,null,"  ",C.a.createElement("button",{onClick:this.showFieldsListModal(!0),title:"Fields List",className:"btn btn-secondary btn-small"},"choose fields"),C.a.createElement(r.Modal,{title:C.a.createElement("div",{className:"modal-header-title"},C.a.createElement("span",{className:"p-l-1"},"Fields List - Table : ",this.state.selectedTable)),isOpen:t,onDismiss:this.showFieldsListModal(!1)},C.a.createElement("div",null,C.a.createElement("table",{style:{width:"100%"}},C.a.createElement("tr",null,C.a.createElement("td",null,"Label"),C.a.createElement("td",null,"Value"),C.a.createElement("td",null,"Type"),C.a.createElement("td",null,"Selected")),Object(m.orderBy)(this.state.fieldsList,["label"],["asc"]).map((function(t){return C.a.createElement("tr",null,C.a.createElement("td",null,t.label),C.a.createElement("td",null,t.name),C.a.createElement("td",null,t.internalType),C.a.createElement("td",null,e.props.query.servicenow[e.props.fieldName].indexOf(t.name)>-1?C.a.createElement("span",{className:"btn btn-danger btn-small",style:{margin:"5px"},onClick:function(){return e.removeField(t.name)}},"remove"):C.a.createElement("span",{className:"btn btn-success btn-small",style:{margin:"5px"},onClick:function(){return e.addField(t.name)}},"  add  ")))}))))))},t}(S.PureComponent),M=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return o(t,e),t.prototype.render=function(){var e=this,t=this.props.query;return C.a.createElement("div",null,C.a.createElement("div",{className:"gf-form-inline"},C.a.createElement("div",{className:"gf-form"},C.a.createElement("label",{className:"gf-form-label width-8",title:"Fields ( Comma separated )"},"Fields"),C.a.createElement("input",{className:"gf-form-input width-30",type:"text",onChange:function(t){return O(t,"fields",e.props,!0)},value:t.servicenow.fields.join(","),placeholder:"Fields ( Comma Separated)",title:"Fields ( Comma Separated )"}),C.a.createElement(I,{onChange:this.props.onChange,query:t,datasource:this.props.datasource,fieldName:"fields"}))))},t}(S.PureComponent),V=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t.state={showHelpModal:!1},t.showHelpModal=function(e){return function(){t.setState({showHelpModal:e})}},t}return o(t,e),t.prototype.render=function(){var e=this.state.showHelpModal;return C.a.createElement(C.a.Fragment,null,"  ",C.a.createElement("button",{onClick:this.showHelpModal(!0),title:"Help",className:"btn btn-secondary btn-small"},"query help"),C.a.createElement(r.Modal,{title:C.a.createElement("div",{className:"modal-header-title"},C.a.createElement("span",{className:"p-l-1"},"Service Now Query Help")),isOpen:e,onDismiss:this.showHelpModal(!1)},C.a.createElement("div",null,C.a.createElement("div",null,C.a.createElement("h4",null,"Time Filter"),C.a.createElement("br",null),C.a.createElement("pre",{style:{display:"inline"}},"$__timeFrom()")," Returns the From datetime from the Grafana picker. Can be used with"," ",C.a.createElement("b",null,"Before / After")," filter.",C.a.createElement("br",null),C.a.createElement("br",null),C.a.createElement("pre",{style:{display:"inline"}},"$__timeTo()")," Returns the To datetime from the Grafana picker. Can be used with"," ",C.a.createElement("b",null,"Before / After")," filter.",C.a.createElement("br",null),C.a.createElement("br",null),C.a.createElement("pre",{style:{display:"inline"}},"$__timeFilter()")," Return start and end time form Grafana picker. Can be used with ",C.a.createElement("b",null,"Between")," ","filter.",C.a.createElement("br",null),C.a.createElement("br",null),C.a.createElement("h4",null,"Relative Time"),C.a.createElement("br",null),C.a.createElement("pre",{style:{display:"inline"}},"@hour@ago@24")," Returns the timestamp of 24 hours ago. Can be used with ",C.a.createElement("b",null,"Relative")," filter.",C.a.createElement("br",null),C.a.createElement("br",null),C.a.createElement("pre",{style:{display:"inline"}},"@hour@ago@-24")," Returns the timestamp of 24 hours from now. Can be used with ",C.a.createElement("b",null,"Relative")," ","filter.",C.a.createElement("br",null),C.a.createElement("br",null),C.a.createElement("p",null,"More help can be found at"," ",C.a.createElement("a",{href:"https://docs.servicenow.com/bundle/orlando-platform-user-interface/page/use/common-ui-elements/reference/r_OpAvailableFiltersQueries.html",target:"_blank",rel:"noopener"},"service-now website."))))))},t}(S.PureComponent),G=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return o(t,e),t.prototype.render=function(){var e=this,t=this.props.query;return C.a.createElement("div",null,C.a.createElement("div",{className:"gf-form-inline"},C.a.createElement("div",{className:"gf-form"},C.a.createElement("label",{className:"gf-form-label width-8",title:"Query"},"Query"),C.a.createElement("textarea",{value:t.servicenow.query||"",onChange:function(t){return O(t,"query",e.props)},className:"gf-form-input min-width-30 width-30",rows:3}),C.a.createElement(V,null))))},t}(S.PureComponent),k=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return o(t,e),t.prototype.render=function(){var e=this,t=this.props.query;return C.a.createElement("div",null,C.a.createElement("div",{className:"gf-form-inline"},C.a.createElement("div",{className:"gf-form"},C.a.createElement("label",{className:"gf-form-label width-8",title:"Group By Field"},"Group By"),C.a.createElement("input",{className:"gf-form-input width-30",type:"text",onChange:function(t){return O(t,"groupBy",e.props,!0)},value:t.servicenow.groupBy.join(","),placeholder:"",title:"Group By"}),C.a.createElement(I,{onChange:this.props.onChange,query:t,datasource:this.props.datasource,fieldName:"groupBy"}))))},t}(S.PureComponent),U=[{label:"Ascending",value:"asc"},{label:"Descending",value:"desc"}],H=[10,25,50,100,250,500,1e3].map((function(e){return{label:e.toString(),value:e.toString()}})),Q=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return o(t,e),t.prototype.render=function(){var e=this,t=this.props.query,a="table"===t.servicenow.type?C.a.createElement(C.a.Fragment,null,C.a.createElement("div",{className:"gf-form-inline"},C.a.createElement("div",{className:"gf-form"},C.a.createElement("label",{className:"gf-form-label width-8",title:"Limit"},"Limit"),C.a.createElement(r.Select,{className:"width-12",value:H.find((function(e){return e.value===t.servicenow.limit}))||{value:t.servicenow.limit,label:t.servicenow.limit},options:H,defaultValue:t.servicenow.limit,onChange:function(t){return F(t,"limit",e.props,"number")},allowCustomValue:!0}),"  ",C.a.createElement("label",{className:"gf-form-label width-8",title:"Order By"},"Order By"),C.a.createElement(r.Select,{className:"width-12",value:B.find((function(e){return e.value===t.servicenow.orderBy}))||{value:t.servicenow.orderBy,label:t.servicenow.orderBy},options:B.filter((function(e){return e.tables.indexOf(t.servicenow.table)>-1})),defaultValue:t.servicenow.orderBy,onChange:function(t){return F(t,"orderBy",e.props)},allowCustomValue:!0}),C.a.createElement(r.Select,{className:"width-8",value:U.find((function(e){return e.value===t.servicenow.orderByDirection})),options:U,defaultValue:t.servicenow.orderByDirection,onChange:function(t){return F(t,"orderByDirection",e.props)}})))):null;return C.a.createElement(C.a.Fragment,null,a)},t}(S.PureComponent),Y=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t.onFilterAdd=function(e){void 0===e&&(e="^");var a=t.props,r=a.query,n=a.onChange,l=r.servicenow,i=new h("number","LIKE","INC",e);l.filters=l.filters||[i],l.filters.push(i),n(s(s({},r),{servicenow:l}))},t.onFilterRemove=function(e){var a=t.props,r=a.query,n=a.onChange,l=r.servicenow,i=new h("active","=","true","^");l.filters=l.filters||[i],l.filters.splice(e,1),n(s(s({},r),{servicenow:l}))},t}return o(t,e),t.prototype.render=function(){var e=this,t=this.props.query;return C.a.createElement("div",null,0===t.servicenow.filters.length?C.a.createElement("div",{className:"gf-form-inline"},C.a.createElement("div",{className:"gf-form"},C.a.createElement("div",{className:"gf-form gf-form--grow"},C.a.createElement("label",{className:"gf-form-label width-8",title:"Filter"},"Filter"))),C.a.createElement("div",{className:"gf-form"},C.a.createElement("div",{className:"gf-form gf-form--grow"},C.a.createElement("span",{className:"btn btn-success btn-small",style:{margin:"5px"},onClick:function(){return e.onFilterAdd("^")}},"Add Filter")))):null,t.servicenow.filters.map((function(a,n){var l;return l=C.a.createElement("input",{type:"text",className:"gf-form-input width-12",title:"Value",placeholder:"Value",value:a.value,onChange:function(t){return O(t,"filters["+n+"].value",e.props)}}),"active"!==a.field||"="!==a.operator&&"!="!==a.operator||(l=C.a.createElement(r.Select,{className:"width-12",value:j.active.find((function(e){return e.value===a.value}))||{value:a.value,label:a.value},options:j.active,defaultValue:"true",onChange:function(t){return F(t,"filters["+n+"].value",e.props)}})),P.map((function(e){return e.value})).indexOf(a.field)>-1&&([">",">=","<","<="].indexOf(a.operator)>-1?l=C.a.createElement(r.Select,{className:"width-12",value:j.grafanaTimestamps.find((function(e){return e.value===a.value}))||{value:a.value,label:a.value},options:j.grafanaTimestamps,defaultValue:"$__timeFrom()",onChange:function(t){return F(t,"filters["+n+"].value",e.props)},allowCustomValue:!0}):["BETWEEN"].indexOf(a.operator)>-1&&(l=C.a.createElement(r.Select,{className:"width-12",value:j.grafanaTimestamps.find((function(e){return e.value===a.value}))||{value:a.value,label:a.value},options:j.grafanaTimestamps,defaultValue:"$__timeFilter()",onChange:function(t){return F(t,"filters["+n+"].value",e.props)},allowCustomValue:!0}))),C.a.createElement("div",{className:"gf-form-inline"},C.a.createElement("div",{className:"gf-form"},C.a.createElement("div",{className:"gf-form gf-form--grow"},C.a.createElement("label",{className:"gf-form-label width-8",title:"Filter"},"Filter ",n+1))),C.a.createElement("div",{className:"gf-form"},C.a.createElement("div",{className:"gf-form gf-form--grow"},C.a.createElement(r.Select,{className:"width-12",value:B.find((function(e){return e.value===a.field}))||{value:a.field,label:a.field},options:B.filter((function(e){return e.tables.indexOf(t.servicenow.table)>-1})),defaultValue:a.field,onChange:function(t){F(t,"filters["+n+"].field",e.props),"active"===t.value?(F({value:"="},"filters["+n+"].operator",e.props),F({value:"true"},"filters["+n+"].value",e.props)):P.map((function(e){return e.value})).indexOf(t.value)>-1?(F({value:">="},"filters["+n+"].operator",e.props),F({value:"$__timeFrom()"},"filters["+n+"].value",e.props)):(F({value:"="},"filters["+n+"].operator",e.props),F({value:""},"filters["+n+"].value",e.props))},allowCustomValue:!0}),C.a.createElement(r.Select,{className:"width-12",value:L.find((function(e){return e.value===a.operator}))||{value:a.operator,label:a.operator},options:L,defaultValue:a.operator,onChange:function(t){return F(t,"filters["+n+"].operator",e.props)},allowCustomValue:!0}),l)),C.a.createElement("span",null,C.a.createElement("div",{className:"gf-form"},C.a.createElement("div",{className:"gf-form gf-form--grow"},n===t.servicenow.filters.length-1?C.a.createElement("span",{className:"btn btn-success btn-small",style:{margin:"5px"},onClick:function(){return e.onFilterAdd("^")}},"+"):C.a.createElement(r.Select,{className:"width-5",value:x.find((function(e){return e.value===(a.condition||"^")})),options:x,defaultValue:a.condition,onChange:function(t){return F(t,"filters["+n+"].condition",e.props)},allowCustomValue:!0}),C.a.createElement("span",{className:"btn btn-danger btn-small",style:{margin:"5px"},onClick:function(){return e.onFilterRemove(n)}},"x")))))})))},t}(S.PureComponent),$=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return o(t,e),t.prototype.render=function(){var e,t=Object(m.defaults)(this.props.query,{servicenow:Object(m.defaults)(this.props.query.servicenow,g)});if(t&&t.servicenow&&t.servicenow.type)switch(t.servicenow.type){case"table":e=C.a.createElement(M,{onChange:this.props.onChange,query:t,datasource:this.props.datasource});break;case"stats":e=C.a.createElement(k,{onChange:this.props.onChange,query:t,datasource:this.props.datasource})}return C.a.createElement("div",null,C.a.createElement(D,{onChange:this.props.onChange,query:t,datasource:this.props.datasource}),e,C.a.createElement(G,{onChange:this.props.onChange,query:t,datasource:this.props.datasource}),C.a.createElement(Y,{onChange:this.props.onChange,query:t,datasource:this.props.datasource}),C.a.createElement(Q,{onChange:this.props.onChange,query:t,datasource:this.props.datasource}))},t}(S.PureComponent),J=function(){function e(){this.supportedTables=R.map((function(e){return{text:e.label,value:e.value}}))}return e.templateUrl="editors/annotations/annotations.editor.html",e}();a.d(t,"plugin",(function(){return W}));var W=new n.DataSourcePlugin(q).setConfigEditor(T).setQueryEditor($).setAnnotationQueryCtrl(J)}])}));